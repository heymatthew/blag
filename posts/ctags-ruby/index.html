<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=/css/bootstrap.min.css><title>CTags in Ruby: Make code feel like a wiki</title></head><body><div class=container><main id=main><h1>CTags in Ruby: Make code feel like a wiki</h1><p>In a browser you markup for links. A wiki builds on this behavior to describes topics, linking nouns to pages in context that link to other nown pages.</p><p>Browsing a wiki allows you to dive into information and build up your mental model of a subject area&ndash; which is kind of addictive. So why can&rsquo;t we do the same thing in our code?</p><p>Code has syntax which are just links between files. We often do this linking in our heads, but our editor should be helping you out more&ndash; at some stage there&rsquo;s a black box that you&rsquo;ve never stepped into because it&rsquo;s outside of your project.</p><p>There have been attempts to make code behave like links through static and dynamic analysis. Here are some of the projects on my radar that pull this off:</p><ol><li><p>[Resource Navigation][1.1] integrated throughtout the Eclipse IDE
[1.1]: <a href=http://help.eclipse.org/neon/topic/org.eclipse.platform.doc.isv/reference/api/org/eclipse/ui/views/navigator/package-summary.html>http://help.eclipse.org/neon/topic/org.eclipse.platform.doc.isv/reference/api/org/eclipse/ui/views/navigator/package-summary.html</a></p></li><li><p>[Ctags][2.1] integration for vim
[2.1]: <a href=http://ricostacruz.com/til/navigate-code-with-ctags>http://ricostacruz.com/til/navigate-code-with-ctags</a></p></li><li><p>[Go Guru][3.1] integration via the [vim-go][3.2] plugin
[3.1]: <a href=https://godoc.org/golang.org/x/tools/cmd/guru>https://godoc.org/golang.org/x/tools/cmd/guru</a>
[3.2]: <a href=https://github.com/fatih/vim-go>https://github.com/fatih/vim-go</a></p></li><li><p>[Sourcegraph][4.1] integartion via the [vim-sourcegraph][4.2] plugin
[4.1]: <a href=https://sourcegraph.com>https://sourcegraph.com</a>
[4.2]: <a href=https://github.com/lazywei/vim-sourcegraph>https://github.com/lazywei/vim-sourcegraph</a></p></li></ol><p>If you&rsquo;re hacking on an opensource project, then sourcegraph is the natural choice at the moment as it gives you access to community and examples you may not have even checked out.</p><p>However I&rsquo;m a Rubyist on a closed source thing at work, and I don&rsquo;t think I can convince my managers just yet to shell out for a sourcegraph subscription. This leaves me with ctags.</p><p>Ctags create a &ldquo;tags&rdquo; file which Vim knows how to navigate out of the box with <code>Ctrl + ]</code>. Those tags are a snapshot of static analysis mapping the links between files in your project.</p><p>If you don&rsquo;t want to mess up your project files though, and you have [vim-fugitive][5], then I recommend you specify your tags file location in <code>.git/tags</code>.
[5]: <a href=https://github.com/tpope/vim-fugitive>https://github.com/tpope/vim-fugitive</a></p><p>Initially I found plugins that ran this command on every file write. However this quickly became unweildy as it builds a massive head of background procs that turn your responsive computer into a slow hulking mass of rage.</p><p>A better way to think about this is &ldquo;when you think code is ready enough to share&rdquo;. This happens for me when I run git commands, specifically <code>git commit</code> and <code>git checkout</code>.</p><p>You can run actions post by adding executable scripts to <code>.git/hooks/</code> with special names. There&rsquo;s a great overview on [githooks.com][6], but for this exersise I&rsquo;m only interested in <code>post-commit</code>, <code>post-checkout</code> and <code>post-rewrite</code>. There are others, but these are the ones I&rsquo;m starting with.
[6]: <a href=http://githooks.com/>http://githooks.com/</a></p><p>First, lets make all these scripts the same</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ln -sf .git/hooks/<span style=color:#f92672>{</span>post-commit,post-checkout<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>ln -sf .git/hooks/<span style=color:#f92672>{</span>post-commit,post-rewrite<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>ls -al .git/hooks
</span></span></code></pre></div><p>Now lets hack together <code>.git/hooks/post-commit</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env ruby</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;time&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TagBuilder</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>CTAGS_TMP</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;.git/ctags.tmp&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>CTAGS_FILE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;.git/ctags&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initalize</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>ctags?
</span></span><span style=display:flex><span>      puts <span style=color:#e6db74>&#34;ctags not present on system&#34;</span>
</span></span><span style=display:flex><span>      exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>gemfile?
</span></span><span style=display:flex><span>      puts <span style=color:#e6db74>&#34;cowardly exiting a project without a gemfile&#34;</span>
</span></span><span style=display:flex><span>      exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>call</span>
</span></span><span style=display:flex><span>    create_tmp_tags_for_project <span style=color:#f92672>and</span> make_tmp_tags_current
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_tmp_tags_for_project</span>
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;building </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>CTAGS_TMP</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    system(<span style=color:#e6db74>&#34;ctags -R -f </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>CTAGS_TMP</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>#{</span>ctags_paths<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_tmp_tags_current</span>
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;updating </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>CTAGS_FILE</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    system(<span style=color:#e6db74>&#34;mv </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>CTAGS_TMP</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>CTAGS_FILE</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ctags?</span>
</span></span><span style=display:flex><span>    system(<span style=color:#e6db74>&#34;which ctags &gt; /dev/null&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gemfile?</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>exist?(<span style=color:#e6db74>&#39;.gemfile&#39;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>ctags_paths</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>cwd<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>#{</span>gem_path<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>cwd</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;.&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gem_path</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>home<span style=color:#e6db74>}</span><span style=color:#e6db74>/.rbenv/versions/</span><span style=color:#e6db74>#{</span>version<span style=color:#e6db74>}</span><span style=color:#e6db74>/lib/ruby/gems&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>home</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#34;HOME&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>version</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>`rbenv version`</span><span style=color:#f92672>.</span>chomp<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39; &#39;</span>)<span style=color:#f92672>.</span>first
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>TagBuilder</span><span style=color:#f92672>.</span>new<span style=color:#f92672>.</span>call
</span></span></code></pre></div><p>Make sure you update permissions to executable!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x .git/hooks/post-commit
</span></span></code></pre></div><p>This script compiles ctags in your current checkout and gemfiles installed and managed by rbenv. And yeah, it&rsquo;s triggered after a commit!</p><p>Test this in vim with with <code>ctrl + ]</code> to &ldquo;follow a link&rdquo;, and <code>ctrl + o</code> to return back to the buffer you came from.</p></main></div></body></html>
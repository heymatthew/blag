<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=/css/bootstrap.min.css><title>Encrypted Directories</title></head><body><div class=container><main id=main><h1>Encrypted Directories</h1><p>In the *nix ecosystem, there are a lot of tools that are great to
chain together. I&rsquo;d encourage everyone to learn their tools, but
sometimes the tools are complex, and you only want to do something
simple.</p><p>I keep forgetting how to crypto. What I generally want to do is
encrypt and sign a directory, then pull that same directory later.</p><p>Here&rsquo;s the script I threw together today. It takes one argument,
either a directory to encrypt, or a gnupg encrypted tar gzipped
directory and extracts it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env ruby</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># gpg_folder - Script to quickly tar, compress and encrypt directories</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Copyright (C) 2017  Matthew B. Gray</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This program is free software: you can redistribute it and/or modify</span>
</span></span><span style=display:flex><span><span style=color:#75715e># it under the terms of the GNU General Public License as published by</span>
</span></span><span style=display:flex><span><span style=color:#75715e># the Free Software Foundation, either version 3 of the License, or</span>
</span></span><span style=display:flex><span><span style=color:#75715e># (at your option) any later version.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This program is distributed in the hope that it will be useful,</span>
</span></span><span style=display:flex><span><span style=color:#75715e># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span></span><span style=display:flex><span><span style=color:#75715e># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span></span><span style=display:flex><span><span style=color:#75715e># GNU General Public License for more details.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># You should have received a copy of the GNU General Public License</span>
</span></span><span style=display:flex><span><span style=color:#75715e># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># GpgFolder service drives the OS to perform encrypt/decrypt methods</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GpgFolder</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Struct</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>:opts</span>) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>call</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span> <span style=color:#66d9ef>if</span> opts<span style=color:#f92672>.</span>errors<span style=color:#f92672>.</span>any?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> opts<span style=color:#f92672>.</span>encrypt?
</span></span><span style=display:flex><span>      do_encrypt
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elsif</span> opts<span style=color:#f92672>.</span>decrypt?
</span></span><span style=display:flex><span>      do_decrypt
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>raise</span> <span style=color:#e6db74>&#34;;_; --not sure what I should do now&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>print_errors</span>
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;Computer says no&#34;</span>
</span></span><span style=display:flex><span>    errors<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>error<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      puts <span style=color:#e6db74>&#34;* </span><span style=color:#e6db74>#{</span>error<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do_encrypt</span>
</span></span><span style=display:flex><span>    run(<span style=color:#e6db74>&#34;tar -cz </span><span style=color:#e6db74>#{</span>opts<span style=color:#f92672>.</span>dir_name<span style=color:#e6db74>}</span><span style=color:#e6db74> | gpg --sign -o </span><span style=color:#e6db74>#{</span>opts<span style=color:#f92672>.</span>archive_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>do_decrypt</span>
</span></span><span style=display:flex><span>    run(<span style=color:#e6db74>&#34;gpg -d </span><span style=color:#e6db74>#{</span>opts<span style=color:#f92672>.</span>archive_name<span style=color:#e6db74>}</span><span style=color:#e6db74> | tar xz&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(cmd)
</span></span><span style=display:flex><span>    puts cmd
</span></span><span style=display:flex><span>    system(cmd)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Interprets how the application was called, used to direct GpgFolder service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Options</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Struct</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>:dir_or_file</span>) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>CRYPT_EXTENSION</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/\.tgz.gpg\z/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>errors</span>
</span></span><span style=display:flex><span>    @errors <span style=color:#f92672>||=</span> <span style=color:#f92672>[].</span>tap <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>unless</span> encrypt? <span style=color:#f92672>^</span> decrypt?
</span></span><span style=display:flex><span>        errors <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Please specify a directory to encrypt, or a file ending in .tgz.gpg&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>encrypt?</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>!</span>dir_or_file<span style=color:#f92672>.</span>nil? <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>decrypt? <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>directory?(dir_or_file)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decrypt?</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>!</span>dir_or_file<span style=color:#f92672>.</span>nil? <span style=color:#f92672>&amp;&amp;</span> dir_or_file<span style=color:#f92672>.</span>match(<span style=color:#66d9ef>CRYPT_EXTENSION</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dir_name</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> encrypt?
</span></span><span style=display:flex><span>      dir_or_file
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      dir_or_file<span style=color:#f92672>.</span>sub(<span style=color:#66d9ef>CRYPT_EXTENSION</span>, <span style=color:#e6db74>&#39;&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>archive_name</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> encrypt?
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>dir_or_file<span style=color:#e6db74>}</span><span style=color:#e6db74>.tgz.gpg&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      dir_or_file
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>opts <span style=color:#f92672>=</span> <span style=color:#66d9ef>Options</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>ARGV</span><span style=color:#f92672>.</span>first)
</span></span><span style=display:flex><span>service <span style=color:#f92672>=</span> <span style=color:#66d9ef>GpgFolder</span><span style=color:#f92672>.</span>new(opts)
</span></span><span style=display:flex><span>service<span style=color:#f92672>.</span>call <span style=color:#f92672>or</span> service<span style=color:#f92672>.</span>print_errors
</span></span></code></pre></div></main></div></body></html>